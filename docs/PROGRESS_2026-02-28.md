# Echo Progress — Feb 28, 2026

## Summary

Two parallel workstreams: iOS third-party app auto-return, macOS Volcano streaming diagnostics.

---

## iOS: Third-Party App Auto-Return

### Goal
After keyboard triggers voice input → Echo opens briefly → records → auto-returns to host app.
`suspend()` works for system apps (Notes) but goes to Home screen for third-party apps.

### Approach 1: PID Passthrough (FAILED)
- Keyboard extension: `_hostProcessIdentifier` returns valid host PID (e.g., 3706)
- Keyboard extension: `_hostApplicationBundleIdentifier` returns `<null>` on iOS 18
- Extension saves PID via `AppGroupBridge.setReturnAppPID()`
- Main app receives PID, calls `proc_pidpath(3706)` → **returns 0** (sandbox blocks it)
- Falls back to `suspend()` → Home screen

### Approach 2: sysctl + LSApplicationWorkspace (DEPLOYED, UNTESTED)
- Replace `proc_pidpath` with `sysctl(KERN_PROC_PID)` → get process name (max 16 chars)
- Match process name against installed apps via `LSApplicationWorkspace.allApplications()`
- 3-pass matching: exact name → prefix match (truncated names) → CFBundleExecutable from Info.plist
- Commit: `9000ff1`

### Files Modified
- `iOS/EchoApp/Views/MainView.swift` — `resolveBundleIDFromPID()` rewritten with sysctl fallback + `matchBundleIDByProcessName()`
- `iOS/EchoKeyboard/VoiceInputTrigger.swift` — PID detection via `_hostProcessIdentifier`
- `Packages/EchoCore/.../AppGroupBridge.swift` — `returnAppPID` / `returnAppBundleID` IPC

### Auto-Return Flow
```
Keyboard Extension:
  detectHostBundleID() → all selectors return <null>
  detectHostPID() → _hostProcessIdentifier → valid PID
  bridge.setReturnAppPID(pid)
  openURLFromExtension(echo://voice)

Main App (autoReturnToHostApp):
  bridge.returnAppBundleID? → try LSApplicationWorkspace.open
  bridge.returnAppPID? → resolveBundleIDFromPID:
    1. proc_pidpath (sandbox-blocked)
    2. sysctl KERN_PROC_PID → process name
    3. LSApplicationWorkspace.allApplications() → match → open
  fallback → suspend()
```

---

## macOS: Volcano Streaming Diagnostics

### Problem
macOS streaming "suddenly not working" — behaving like batch mode.

### Investigation Results
- **Credentials**: Valid. AES-256-GCM decryption test passed. Keychain has correct volcano_app_id + volcano_access_key.
- **Settings**: Correct. `selectedASRProvider=volcano`, `asrMode=stream`, `apiCallMode=clientDirect`.
- **Endpoint**: Stored endpoint is batch HTTP URL (irrelevant — `startStreaming()` uses hardcoded WSS endpoint).
- **WebSocket**: Connectivity test passed (wss://openspeech.bytedance.com/api/v3/sauc/bigmodel_async).
- **UserDefaults confusion**: Two domains — `com.echo.mac` (old build, wrong settings) vs `com.xianggui.echo.mac` (correct).
- **Root cause**: Likely stale app binary. Fresh build resolved it.

### Resolution
User confirmed after new build: "现在是可以实时输出了" (streaming outputs in real-time now).

### Diagnostics Added
- `VoiceInputService.swift`: `asrDiag()` writes to `UserDefaults.standard["echo.debug.asrDiag"]`
- `AppDelegate.swift`: Startup diag writes provider/mode/credentials summary
- Readable via: `defaults read com.xianggui.echo.mac echo.debug.startupDiag`

### Test Scripts Created
- `/tmp/test_decrypt.swift` — Standalone EmbeddedKeyProvider decryption verification
- `/tmp/test_volcano_ws.swift` — WebSocket connectivity test to Volcano endpoint

---

## RemoteLogger (UDP) System

Wireless iOS debug logging: `rlog("message")` → UDP to Mac.
- Mac IP: `192.168.86.40`, Port: `9877`
- Receiver: `python3 /tmp/echo_log_receiver.py > /tmp/echo_logs.txt`
- View: `tail -f /tmp/echo_logs.txt`

---

## Build & Deploy Commands

```bash
# iOS
xcodebuild -project Echo.xcodeproj -target EchoApp -sdk iphoneos -configuration Debug \
  SYMROOT=/tmp/echo-build-0225 DEVELOPMENT_TEAM=D7BK236H9B \
  CODE_SIGN_IDENTITY="Apple Development" CODE_SIGN_STYLE=Automatic

xcrun devicectl device install app --device "D66DE9A7-41BF-5F89-B1F4-B9B990912BC0" \
  /tmp/echo-build-0225/Debug-iphoneos/EchoApp.app

# macOS
xcodebuild -project Echo.xcodeproj -target EchoMac -configuration Debug \
  SYMROOT=/tmp/echo-build-mac DEVELOPMENT_TEAM=D7BK236H9B \
  CODE_SIGN_IDENTITY="Apple Development" CODE_SIGN_STYLE=Automatic
```

## Device
- iPhone 15 Pro Max (iPhone16,2), iOS 18.7.3
- Device ID: `D66DE9A7-41BF-5F89-B1F4-B9B990912BC0`

---

## Open Items
- [ ] Test sysctl approach on real device (deployed but untested)
- [ ] macOS: Further test real-time transcription + correction quality
- [ ] macOS: Customizable final ASR finalization + AutoEdit polish
- [ ] `correctionEnabled` is `0` (disabled) — needs enabling for polish flow

*Branch: `feature/rebuild-from-0225` | Commit: `9000ff1`*
